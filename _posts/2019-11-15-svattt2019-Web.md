---
layout: post
title: TiÃªn tri vÅ© trá»¥ Tráº§n Tiger
subtitle: Pentest Web - PHP Deobfuscate
tags: [ctf,attt2019,web,php-deobfuscate]
image: /img/tran_tiger.png
share-img: /img/tran_tiger.png
---
ChÃ o má»i ngÆ°á»i Ä‘Ã¢y lÃ  post Ä‘áº§u tiÃªn cá»§a mÃ¬nh trÃªn blog. Tháº­t ra thÃ¬ láº§n Ä‘áº§u Ä‘i thi SVATTT2019 cáº£m tháº¥y ráº¥t hÃ o há»©ng, bÃªn cáº¡nh Ä‘Ã³ thÃ¬ cÅ©ng cháº£ biáº¿t khá»‰ gÃ¬ trong Ä‘áº§u, may thay káº¿t thÃºc vÃ²ng loáº¡i, thÃ¬ team mÃ¬nh cÅ©ng cÃ³ cÃ¡i giáº£i lÃ  `giáº£i khuyáº¿n khÃ­ch` :)))

NÃ³i chung lÃ  cáº£ team noob nÃªn Ä‘i Ä‘á»ƒ há»c há»i lÃ  chÃ­nh vÃ  ngáº¯m gÃ¡i SIU lÃ  10, vá» pháº§n mÃ¬nh thÃ¬ thi xong giáº£i Ä‘Ã³ mÃ¬nh cÅ©ng cháº£ giáº£i ra chall nÃ o cáº£, nÃªn vá» nhÃ  hardcore láº¡i vÃ  cÅ©ng tÃ¬m hiá»ƒu Ä‘Ã´i chÃºt pass qua Ä‘Æ°á»£c chal `Tráº§n Tiger` nÃ y.

Nghe báº£o Ä‘Ã¢y cÃ²n lÃ  chall cho Ä‘iá»ƒm ğŸ‘»
Sau khi config docker vÃ  clone tá»« anh `Tsu` thÃ¬ cÅ©ng Ä‘Ã£ gáº·p láº¡i Mr.Tiger 

<img src="/img/15112019/01.png" alt="Config challenge" align="center"/>

NhÃ¬n vÃ o Ä‘á» bÃ i lÃºc Ä‘áº§u cÅ©ng cháº£ hÃ¬nh dung ra gÃ¬, cá»© Ä‘á»c nhá»¯ng cÃ¢u thoáº¡i ná»•i tiáº¿ng cá»§a Mr.Tiger thÃ¬ chá»‰ nháº­n tháº¥y nhá»¯ng file Ä‘Æ°á»£c load tá»« há»‡ thá»‘ng lÃªn url..

<img src="/img/15112019/02.png" alt="Test submit" align="center"/>

Cá»© thá»­ payload liÃªn tá»¥c..
>http://localhost:8004/?tientri=/etc/passwd

>http://localhost:8004/?tientri=../../../../etc/passwd

NhÆ°ng cÅ©ng bá»‹ cháº·n ná»‘t, liÃªn tá»¥c responder `Äá»“ DÃ´ DÄƒn QÃ³a ğŸ˜ ` láº§n Ä‘áº§u pentest cÅ©ng khÃ¡ báº¿ táº¯c nÃªn ngá»“i search má»™t lÃºc thÃ¬ tháº¥y tools [dirsearch](http://https://github.com/maurosoria/dirsearch) Ä‘á»ƒ brute force dir trong site nÃ y, sau khi run xong thÃ¬ nháº­n tháº¥y cÃ³ folder ráº¥t quen Ä‘Ã³ lÃ  `upload`

<img src="/img/15112019/03.png" alt="Dirsearch Brute Force" align="center"/>

Liá»n truy cáº­p vÃ o thÃ¬ cÅ©ng nháº­n tháº¥y cÃ³ thÃªm lá»—i "Directory Listing", ngoÃ i ra cÃ²n cÃ³ file flag.php click vÃ´ xem bÃ¹m `Flag Cena` 

<img src="/img/15112019/04.png" alt="Upload directory" align="center"/>

Khi xem qua háº¿t cÃ¡c file thÃ¬ cÃ³ tháº¥y file khÃ¡ nghi ngá» lÃ  backdoor.php, thÆ°á»ng thÃ¬ file nÃ y do admin hay attacker Ä‘á»ƒ láº¡i vá»›i má»¥c Ä‘Ã­ch dá»… truy cáº­p Ä‘á»ƒ Ä‘iá»u khiá»ƒn há»‡ thá»‘ng. Truy cáº­p vÃ o thÃ¬ tháº¥y khÃ¡ nhiá»u ğŸ’© theo Ä‘Ãºng nghÄ©a Ä‘en láº«n nghÄ©a bÃ³ng ..

<img src="/img/15112019/05.png" alt="Access backdoor.php" align="center"/>

Sau má»™t há»“i payload cÅ©ng mÃ² ra Ä‘Æ°á»£c má»™t Ä‘á»‘ng source code cháº£ hiá»ƒu gÃ¬

>http://localhost:8004/?tientri=backdoor.php

<img src="/img/15112019/06.png" alt="Payload backdoor.php" align="center"/>

Up source code Ä‘á»ƒ debug váº­y, sau khi setup vá» local cá»§a mÃ¡y thÃ¬ Ä‘i tháº³ng vÃ o source code

<img src="/img/15112019/07.png" alt="Source code" align="center"/>

ThÃ¬ ta tháº¥y tÃ¡c giáº£ Ä‘á»ƒ 2 dÃ²ng code nÃ y nháº±m trÃ¡nh in ra lá»—i nÃªn khÃ´ng debug Ä‘Æ°á»£c nÃªn xÃ³a 2 dÃ²ng code nÃ y Ä‘i..
```php
<?php
error_reporting(0);
@ini_set('display_errors', 0);
?>
```

ThÃ¬ mÃ¬nh cháº¡y láº¡i, woaa xá»• ra cáº£ má»› lá»—i 

<img src="/img/15112019/08.png" alt="Code error" align="center"/>

ÄÃ¢y cÅ©ng lÃ  nhá»¯ng lá»—i do tÃ¡c giáº£ Ä‘Æ°a ra vÃ¬ chÆ°a defined..
Tiáº¿p theo pháº£i debug á»Ÿ nhá»¯ng chá»— input thÃ¬ trong PHP sáº½ gá»“m GET/POST, mÃ¬nh báº¯t Ä‘áº§u tÃ¬m tháº¥y 3 nÆ¡i input báº±ng method `GET` sáºµn tiá»‡n format láº¡i code cho dá»… nhÃ¬n...

Äá»ƒ Ã½ dÃ²ng dÆ°á»›i cÃ¹ng cá»§a má»› há»—n Ä‘á»™n lá»—i á»Ÿ trÃªn ta tháº¥y 1 function `vwuu4y()` ngay dÃ²ng `Fatal error`
>Fatal error: Uncaught Error: Call to undefined function vwuu4y() in E:\xampp\htdocs\pentest\index.php:2 Stack trace: #0 {main} thrown in E:\xampp\htdocs\pentest\index.php on line 2

Theo mÃ¬nh nghÄ© sáº½ chá»©a gÃ¬ Ä‘Ã³ trong function rá»“i encode theo hÆ°á»›ng nÃ o Ä‘Ã³ Ä‘á»ƒ mÃ¬nh convert vá» Ä‘Ãºng function nhÆ° Ã½ tÃ¡c giáº£

Tiáº¿p theo mÃ¬nh sáº½ var_dump tá»«ng biáº¿n input trong method GET Ä‘á»ƒ xem cÃ³ gÃ¬ trong Ä‘áº¥y..

```php
var_dump($_________________);
$__=!""*73+25-72-$_GET[$_________________];
```
<img src="/img/15112019/09.png" alt="var_dump()" align="center"/>

ThÃ¬ nhÆ° thÃ´ng bÃ¡o dÃ²ng input Ä‘Ã³ báº¯t mÃ¬nh nháº­p vÃ o kÃ­ tá»± `o`
NhÆ° váº­y mÃ¬nh sáº½ nháº­p `o` vÃ o url vÃ  kÃ¨m theo Ä‘Ã³ brute force Ä‘á»ƒ xem nháº­n láº¡i Ä‘Æ°á»£c gÃ¬ khÃ´ng...
>http://localhost:8076/pentest/index.php?o=12

ThÃ¬ nÃ³ Ä‘Ã£ Ä‘á»•i sang function `strr4v()`
NhÆ° váº­y thÃ¬ cáº§n brute force báº±ng sá»‘ Ä‘á»ƒ leak thÃªm nhiá»u function thÃ¬ mÃ¬nh sáº½ dÃ¹ng burp suite Ä‘á»ƒ leak..
Vá»›i má»—i payload sáº½ noti ra `Call to undefined function` vá»›i má»—i name khÃ¡c nhau, nhÆ° váº­y ta hÃ¬nh dung ra náº¿u payload Ä‘Ãºng sáº½ khÃ´ng hiá»‡n dÃ²ng thÃ´ng bÃ¡o trÃªn vÃ¬ váº­y filter dÃ²ng noti nÃ y thÃ¬ nháº­n Ä‘Æ°á»£c payload lÃ  `25`

<img src="/img/15112019/10.png" alt="Payload burpsuite" align="center"/>

MÃ¬nh sáº½ dump tiáº¿p 2 biáº¿n GET cÃ²n láº¡i..

```php
var_dump($_________________);
var_dump($__________);
$_GET[$_________________]($_GET[$__________]);
```

ThÃ¬ nháº­n Ä‘Æ°á»£c dÃ²ng thÃ´ng bÃ¡o nhÆ° hÃ¬nh bÃªn dÆ°á»›i..

<img src="/img/15112019/11.png" alt="Payload burpsuite" align="center"/>

LÃºc nÃ y sáº½ dá»… hÃ¬nh dung hÆ¡n 2 biáº¿n GET nÃ y lÃ :

> $GET["tsutsu"]($GET["e"]);

Giá» chá»‰ cáº§n cháº¡y url brute force Ä‘á»ƒ xem nhÆ° nÃ o ^^

>http://localhost:8004/upload/tientri/backdoor.php?o=25&tsutsu=passthru&e=ls

>http://localhost:8004/upload/tientri/backdoor.php?o=25&tsutsu=passthru&e=ls%20../

>http://localhost:8004/upload/tientri/backdoor.php?o=25&tsutsu=passthru&e=cat%20../flag.php

<img src="/img/15112019/12.png" alt="Payload burpsuite" align="center"/>

**Flag: SVATTT{Defe4t_Th3_PhP_ObfuScate!}**

***

Tháº­t ra pháº£i tÃ¬m hiá»ƒu Ä‘á»§ thá»© sau kÃ¬ thi má»›i pass Ä‘Æ°á»£c bÃ i nÃ y vÃ  cÅ©ng há»c Ä‘Æ°á»£c nhiá»u thá»©, cáº£m Æ¡n anh `Tsu` ráº¥t nhiá»u. Cáº£m Æ¡n má»i ngÆ°á»i Ä‘Ã£ ghÃ© Ä‘á»c.

Cheering ...

![Alt Text](https://media.giphy.com/media/SyemapFxj7TiM/giphy.gif)
